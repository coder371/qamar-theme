{# Search Page Widget #}

{% set desktopCols = {
  '3': 'lg:grid-cols-3',
  '4': 'lg:grid-cols-4'
}[widget.data.columns_desktop] | default('lg:grid-cols-4') %}

<div class="search-page py-8" x-data="{
  query: '{{ search.query | default('') }}',
  sortBy: '{{ search.sort | default('relevance') }}',
  filtersOpen: false,

  updateSearch() {
    const params = new URLSearchParams(window.location.search);
    if (this.query) params.set('q', this.query);
    if (this.sortBy && this.sortBy !== 'relevance') params.set('sort', this.sortBy);
    window.location.search = params.toString();
  },

  clearFilters() {
    window.location.href = '/search?q=' + encodeURIComponent(this.query);
  }
}">
  <div class="container mx-auto px-4">

    {# Search Header #}
    <div class="mb-8">
      <form @submit.prevent="updateSearch()" class="max-w-2xl mx-auto">
        <div class="relative">
          <input
            type="search"
            x-model="query"
            placeholder="{{t('search.placeholder')}}"
            class="w-full py-4 px-6 pe-14 text-lg border-2 border-gray-200 rounded-full focus:border-primary focus:outline-none transition-colors">
          <button
            type="submit"
            class="absolute top-1/2 end-4 -translate-y-1/2 w-10 h-10 flex items-center justify-center bg-primary text-white rounded-full hover:bg-primary-dark transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </button>
        </div>
      </form>
    </div>

    {% if search.query %}
      {# Results Header #}
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
          <h1 class="text-2xl font-bold">{{t("search.results_for")}} "{{ search.query }}"</h1>
          <p class="text-gray-500 mt-1">{{ search.total | default(0) }} {{t("search.results_count")}}</p>
        </div>

        <div class="flex items-center gap-4">
          {# Mobile Filter Toggle #}
          {% if widget.data.show_filters %}
            <button
              @click="filtersOpen = !filtersOpen"
              class="lg:hidden btn btn-outline">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
              </svg>
              {{t("collection.filters")}}
            </button>
          {% endif %}

          {# Sort #}
          {% if widget.data.show_sort %}
            <select
              x-model="sortBy"
              @change="updateSearch()"
              class="input py-2 px-4">
              <option value="relevance">{{t("search.sort_relevance")}}</option>
              <option value="newest">{{t("collection.sort_newest")}}</option>
              <option value="price_asc">{{t("collection.sort_price_asc")}}</option>
              <option value="price_desc">{{t("collection.sort_price_desc")}}</option>
              <option value="name_asc">{{t("collection.sort_name_asc")}}</option>
            </select>
          {% endif %}
        </div>
      </div>

      {% if search.products and search.products.length > 0 %}
        <div class="flex flex-col lg:flex-row gap-8">

          {# Filters Sidebar #}
          {% if widget.data.show_filters %}
            <aside
              class="lg:w-64 flex-shrink-0"
              :class="filtersOpen ? 'block' : 'hidden lg:block'">
              <div class="bg-white rounded-xl shadow-sm p-6 sticky top-24">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-bold">{{t("collection.filters")}}</h3>
                  <button
                    @click="clearFilters()"
                    class="text-sm text-primary hover:underline">
                    {{t("collection.clear_filters")}}
                  </button>
                </div>

                {# Price Filter #}
                <div class="border-t pt-4">
                  <h4 class="font-medium mb-3">{{t("collection.filter_price")}}</h4>
                  <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" class="form-checkbox text-primary rounded">
                      <span class="text-sm">{{t("collection.price_under")}} 100</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" class="form-checkbox text-primary rounded">
                      <span class="text-sm">100 - 200</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" class="form-checkbox text-primary rounded">
                      <span class="text-sm">200 - 500</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" class="form-checkbox text-primary rounded">
                      <span class="text-sm">{{t("collection.price_over")}} 500</span>
                    </label>
                  </div>
                </div>

                {# Categories Filter #}
                {% if search.categories and search.categories.length > 0 %}
                  <div class="border-t pt-4 mt-4">
                    <h4 class="font-medium mb-3">{{t("collection.filter_category")}}</h4>
                    <div class="space-y-2">
                      {% for category in search.categories %}
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" class="form-checkbox text-primary rounded">
                          <span class="text-sm">{{ category.name }}</span>
                          <span class="text-xs text-gray-400">({{ category.count }})</span>
                        </label>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              </div>
            </aside>
          {% endif %}

          {# Products Grid #}
          <div class="flex-1">
            <div class="grid grid-cols-2 md:grid-cols-3 {{ desktopCols }} gap-4 md:gap-6">
              {% for product in search.products %}
                {% ui "product-card", { product: product } %}
              {% endfor %}
            </div>

            {# Pagination #}
            {% if search.pagination and search.pagination.totalPages > 1 %}
              <nav class="flex justify-center mt-12">
                <div class="flex items-center gap-2">
                  {% if search.pagination.currentPage > 1 %}
                    <a
                      href="?q={{ search.query }}&page={{ search.pagination.currentPage - 1 }}"
                      class="w-10 h-10 flex items-center justify-center rounded-lg border hover:bg-gray-50">
                      <svg class="w-5 h-5 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                      </svg>
                    </a>
                  {% endif %}

                  {% for page in range(1, search.pagination.totalPages + 1) %}
                    {% if page == search.pagination.currentPage %}
                      <span class="w-10 h-10 flex items-center justify-center rounded-lg bg-primary text-white font-medium">
                        {{ page }}
                      </span>
                    {% elif page == 1 or page == search.pagination.totalPages or (page >= search.pagination.currentPage - 2 and page <= search.pagination.currentPage + 2) %}
                      <a
                        href="?q={{ search.query }}&page={{ page }}"
                        class="w-10 h-10 flex items-center justify-center rounded-lg border hover:bg-gray-50">
                        {{ page }}
                      </a>
                    {% elif page == search.pagination.currentPage - 3 or page == search.pagination.currentPage + 3 %}
                      <span class="px-2">...</span>
                    {% endif %}
                  {% endfor %}

                  {% if search.pagination.currentPage < search.pagination.totalPages %}
                    <a
                      href="?q={{ search.query }}&page={{ search.pagination.currentPage + 1 }}"
                      class="w-10 h-10 flex items-center justify-center rounded-lg border hover:bg-gray-50">
                      <svg class="w-5 h-5 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                    </a>
                  {% endif %}
                </div>
              </nav>
            {% endif %}
          </div>
        </div>

      {% else %}
        {# No Results #}
        <div class="max-w-md mx-auto text-center py-16">
          <svg class="w-32 h-32 mx-auto text-gray-300 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <h2 class="text-2xl font-bold text-gray-600 mb-2">{{t("search.no_results")}}</h2>
          <p class="text-gray-400 mb-8">{{t("search.no_results_message")}}</p>
          <a href="/products" class="btn btn-primary btn-lg">
            {{t("search.browse_products")}}
          </a>
        </div>
      {% endif %}

    {% else %}
      {# No Search Query #}
      <div class="max-w-md mx-auto text-center py-16">
        <svg class="w-32 h-32 mx-auto text-gray-300 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <h2 class="text-2xl font-bold text-gray-600 mb-2">{{t("search.start_searching")}}</h2>
        <p class="text-gray-400 mb-8">{{t("search.start_searching_message")}}</p>
      </div>
    {% endif %}
  </div>
</div>
