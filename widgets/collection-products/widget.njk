{# Collection Products Widget - Uses collection variable from context #}

{% set desktopCols = {
  '3': 'lg:grid-cols-3',
  '4': 'lg:grid-cols-4'
}[widget.data.columns_desktop] | default('lg:grid-cols-4') %}

{% set mobileCols = {
  '1': 'grid-cols-1',
  '2': 'grid-cols-2'
}[widget.data.columns_mobile] | default('grid-cols-2') %}

{% set showFilters = widget.data.show_filters | default(true) %}
{% set showSort = widget.data.show_sort | default(true) %}
{% set filterPosition = widget.data.filter_position | default('sidebar') %}

<section
  class="py-8"
  x-data="{
    filters: {
      minPrice: '',
      maxPrice: '',
      colors: [],
      sizes: []
    },
    sort: '',
    view: 'grid',
    filtersOpen: false,

    applyFilters() {
      // In a real implementation, this would filter products
      console.log('Applying filters:', this.filters);
    },

    clearFilters() {
      this.filters = {
        minPrice: '',
        maxPrice: '',
        colors: [],
        sizes: []
      };
      this.applyFilters();
    }
  }">
  <div class="container mx-auto px-4">

    {# Toolbar #}
    <div class="flex flex-wrap items-center justify-between gap-4 mb-6 pb-4 border-b">
      {# Results count #}
      <p class="text-gray-600">
        <span class="font-medium">{{ collection.productsCount | default(0) }}</span>
        {{t("collection.products_count")}}
      </p>

      <div class="flex items-center gap-4">
        {# Mobile Filter Button #}
        {% if showFilters and filterPosition != 'top' %}
          <button
            @click="filtersOpen = !filtersOpen"
            class="lg:hidden btn btn-outline btn-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
            </svg>
            {{t("collection.filters")}}
          </button>
        {% endif %}

        {# Sort Dropdown #}
        {% if showSort %}
          <div class="relative" x-data="{ open: false }">
            <button
              @click="open = !open"
              @click.outside="open = false"
              class="btn btn-outline btn-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"/>
              </svg>
              {{t("collection.sort")}}
            </button>
            <div
              x-show="open"
              x-transition
              class="absolute end-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-20">
              <button @click="sort = ''; open = false" class="w-full px-4 py-2 text-start hover:bg-gray-50">
                {{t("search.newest")}}
              </button>
              <button @click="sort = 'price-asc'; open = false" class="w-full px-4 py-2 text-start hover:bg-gray-50">
                {{t("search.price_low_high")}}
              </button>
              <button @click="sort = 'price-desc'; open = false" class="w-full px-4 py-2 text-start hover:bg-gray-50">
                {{t("search.price_high_low")}}
              </button>
              <button @click="sort = 'rating-desc'; open = false" class="w-full px-4 py-2 text-start hover:bg-gray-50">
                {{t("search.highest_rated")}}
              </button>
            </div>
          </div>
        {% endif %}

        {# View Toggle #}
        <div class="hidden md:flex items-center border rounded-lg overflow-hidden">
          <button
            @click="view = 'grid'"
            :class="view === 'grid' ? 'bg-primary text-white' : 'bg-white text-gray-600'"
            class="p-2 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
            </svg>
          </button>
          <button
            @click="view = 'list'"
            :class="view === 'list' ? 'bg-primary text-white' : 'bg-white text-gray-600'"
            class="p-2 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    {# Main Content #}
    <div class="flex gap-8">

      {# Sidebar Filters #}
      {% if showFilters and filterPosition == 'sidebar' %}
        <aside
          class="hidden lg:block w-64 flex-shrink-0"
          :class="filtersOpen ? 'fixed inset-0 z-50 bg-white p-6 block lg:relative lg:inset-auto lg:z-auto lg:p-0' : ''">

          {# Mobile close button #}
          <button
            @click="filtersOpen = false"
            class="lg:hidden absolute top-4 end-4">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>

          <h3 class="text-lg font-bold mb-6">{{t("collection.filters")}}</h3>

          {# Price Filter #}
          <div class="mb-6">
            <h4 class="font-medium mb-3">{{t("collection.price_range")}}</h4>
            <div class="flex gap-2">
              <input
                type="number"
                x-model="filters.minPrice"
                placeholder="{{t('search.min_price')}}"
                class="input text-sm">
              <span class="self-center">-</span>
              <input
                type="number"
                x-model="filters.maxPrice"
                placeholder="{{t('search.max_price')}}"
                class="input text-sm">
            </div>
          </div>

          {# Color Filter #}
          {% if collection.availableColors %}
            <div class="mb-6">
              <h4 class="font-medium mb-3">{{t("product.color")}}</h4>
              <div class="flex flex-wrap gap-2">
                {% for color in collection.availableColors %}
                  <button
                    @click="filters.colors.includes('{{ color.name }}') ? filters.colors = filters.colors.filter(c => c !== '{{ color.name }}') : filters.colors.push('{{ color.name }}')"
                    :class="filters.colors.includes('{{ color.name }}') ? 'ring-2 ring-primary ring-offset-2' : ''"
                    class="w-8 h-8 rounded-full border-2 border-gray-200"
                    style="background-color: {{ color.value | default('#ccc') }}"
                    title="{{ color.name }}">
                  </button>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {# Size Filter #}
          {% if collection.availableSizes %}
            <div class="mb-6">
              <h4 class="font-medium mb-3">{{t("product.size")}}</h4>
              <div class="flex flex-wrap gap-2">
                {% for size in collection.availableSizes %}
                  <button
                    @click="filters.sizes.includes('{{ size }}') ? filters.sizes = filters.sizes.filter(s => s !== '{{ size }}') : filters.sizes.push('{{ size }}')"
                    :class="filters.sizes.includes('{{ size }}') ? 'bg-primary text-white border-primary' : 'bg-white border-gray-300'"
                    class="px-3 py-1 border rounded text-sm font-medium transition-colors">
                    {{ size }}
                  </button>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {# Apply/Clear Buttons #}
          <div class="flex gap-2">
            <button @click="applyFilters()" class="btn btn-primary flex-1">
              {{t("search.apply")}}
            </button>
            <button @click="clearFilters()" class="btn btn-outline">
              {{t("collection.clear_filters")}}
            </button>
          </div>
        </aside>
      {% endif %}

      {# Products Grid #}
      <div class="flex-1">
        {% if collection.products and collection.products.length > 0 %}
          {# Grid View #}
          <div
            x-show="view === 'grid'"
            class="grid {{ mobileCols }} md:grid-cols-3 {{ desktopCols }} gap-4 md:gap-6">
            {% for product in collection.products %}
              {% ui "product-card.njk", product=product %}
            {% endfor %}
          </div>

          {# List View #}
          <div x-show="view === 'list'" class="space-y-4">
            {% for product in collection.products %}
              <div class="flex gap-4 p-4 bg-white rounded-lg shadow-sm">
                <a href="/product/{{ product.slug }}" class="w-32 h-32 flex-shrink-0">
                  <img
                    src="{{ product.images[0].fileUrl }}"
                    alt="{{ product.title }}"
                    class="w-full h-full object-cover rounded-lg">
                </a>
                <div class="flex-1">
                  <h3 class="font-medium mb-1">
                    <a href="/product/{{ product.slug }}" class="hover:text-primary">
                      {{ product.title }}
                    </a>
                  </h3>
                  <p class="text-sm text-gray-500 mb-2 line-clamp-2">{{ product.shortDescription }}</p>
                  <div class="flex items-center justify-between">
                    <span class="text-lg font-bold text-primary" data-money="{{ product.pricing.price }}">{{ product.pricing.price | money }}</span>
                    <button
                      @click="Qumra.cart.add('{{ product._id }}')"
                      class="btn btn-primary btn-sm">
                      {{t("product.add_to_cart")}}
                    </button>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          {# Pagination #}
          {% if collection.totalPages > 1 %}
            <nav class="flex justify-center mt-8">
              <ul class="flex items-center gap-1">
                {# Previous #}
                <li>
                  <a
                    href="?page={{ collection.currentPage - 1 }}"
                    class="w-10 h-10 flex items-center justify-center rounded-lg {% if collection.currentPage <= 1 %}opacity-50 pointer-events-none{% else %}hover:bg-gray-100{% endif %}">
                    <svg class="w-5 h-5 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                  </a>
                </li>

                {# Page numbers #}
                {% for page in range(1, collection.totalPages + 1) %}
                  <li>
                    <a
                      href="?page={{ page }}"
                      class="w-10 h-10 flex items-center justify-center rounded-lg font-medium {% if page == collection.currentPage %}bg-primary text-white{% else %}hover:bg-gray-100{% endif %}">
                      {{ page }}
                    </a>
                  </li>
                {% endfor %}

                {# Next #}
                <li>
                  <a
                    href="?page={{ collection.currentPage + 1 }}"
                    class="w-10 h-10 flex items-center justify-center rounded-lg {% if collection.currentPage >= collection.totalPages %}opacity-50 pointer-events-none{% else %}hover:bg-gray-100{% endif %}">
                    <svg class="w-5 h-5 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </a>
                </li>
              </ul>
            </nav>
          {% endif %}

        {% else %}
          {# No Products #}
          <div class="text-center py-16">
            <svg class="w-24 h-24 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
            <h3 class="text-xl font-bold text-gray-600 mb-2">{{t("collection.no_products")}}</h3>
            <p class="text-gray-400 mb-4">لا توجد منتجات في هذا التصنيف حالياً</p>
            <a href="/products" class="btn btn-primary">
              {{t("common.view_all")}} {{t("common.products")}}
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {# Mobile Filters Overlay #}
  <div
    x-show="filtersOpen"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    @click="filtersOpen = false"
    class="lg:hidden fixed inset-0 bg-black/50 z-40">
  </div>
</section>
