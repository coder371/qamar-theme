{# Product Layout Widget - Complete product page layout #}

{% set hasDiscount = product.pricing.compareAtPrice and product.pricing.compareAtPrice > product.pricing.price %}
{% set discountPercent = ((product.pricing.compareAtPrice - product.pricing.price) / product.pricing.compareAtPrice * 100) | round if hasDiscount else 0 %}
{% set isOutOfStock = product.quantity <= 0 %}
{% set thumbnailsPosition = widget.data.thumbnails_position | default('bottom') %}
{% set enableZoom = widget.data.enable_zoom | default(true) %}
{% set enableLightbox = widget.data.enable_lightbox | default(true) %}

<div class="product-page py-8">
  <div class="container mx-auto px-4">

    {# Breadcrumb #}
    <nav class="mb-6">
      <ol class="flex items-center gap-2 text-sm">
        <li><a href="/" class="text-gray-500 hover:text-primary">{{t("common.home")}}</a></li>
        <li class="text-gray-400">/</li>
        {% if product.collection %}
          <li><a href="/collection/{{ product.collection.slug }}" class="text-gray-500 hover:text-primary">{{ product.collection.title }}</a></li>
          <li class="text-gray-400">/</li>
        {% endif %}
        <li class="text-gray-900 font-medium">{{ product.title }}</li>
      </ol>
    </nav>

    {# Main Product Section #}
    <div
      class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12"
      x-data="{
        currentImage: 0,
        images: {{ product.images | dump | safe }},
        lightbox: false,
        zoom: false,
        zoomX: 50,
        zoomY: 50,
        quantity: 1,
        selectedOptions: {},
        loading: false,

        init() {
          {% for option in product.options %}
            this.selectedOptions['{{ option.name }}'] = '{{ option.values[0].name }}';
          {% endfor %}
        },

        next() { this.currentImage = (this.currentImage + 1) % this.images.length; },
        prev() { this.currentImage = (this.currentImage - 1 + this.images.length) % this.images.length; },
        goTo(index) { this.currentImage = index; },
        handleZoom(e) {
          const rect = e.target.getBoundingClientRect();
          this.zoomX = ((e.clientX - rect.left) / rect.width) * 100;
          this.zoomY = ((e.clientY - rect.top) / rect.height) * 100;
        },
        increment() { if (this.quantity < {{ product.quantity | default(99) }}) this.quantity++; },
        decrement() { if (this.quantity > 1) this.quantity--; },
        async addToCart() {
          this.loading = true;
          await Qumra.cart.add('{{ product._id }}', this.quantity, this.selectedOptions);
          this.loading = false;
        },
        async addToWishlist() {
          await Qumra.wishlist.toggle('{{ product._id }}');
        }
      }">

      {# Gallery #}
      <div class="{% if widget.data.gallery_position == 'end' %}lg:order-2{% endif %}">
        <div class="flex {% if thumbnailsPosition == 'side' %}flex-row gap-4{% else %}flex-col{% endif %}">

          {# Thumbnails (Side) #}
          {% if thumbnailsPosition == 'side' and product.images | length > 1 %}
            <div class="hidden md:flex flex-col gap-2 w-20 flex-shrink-0">
              {% for image in product.images %}
                <button
                  @click="goTo({{ loop.index0 }})"
                  :class="currentImage === {{ loop.index0 }} ? 'ring-2 ring-primary' : 'ring-1 ring-gray-200'"
                  class="w-20 h-20 rounded-lg overflow-hidden bg-gray-100 transition-all">
                  <img src="{{ image.fileUrl }}" alt="{{ product.title }}" class="w-full h-full object-cover">
                </button>
              {% endfor %}
            </div>
          {% endif %}

          {# Main Image #}
          <div class="flex-1">
            <div
              class="relative aspect-square rounded-xl overflow-hidden bg-gray-100 cursor-{% if enableZoom %}zoom-in{% else %}pointer{% endif %}"
              {% if enableZoom %}@mouseenter="zoom = true" @mouseleave="zoom = false" @mousemove="handleZoom($event)"{% endif %}
              {% if enableLightbox %}@click="lightbox = true"{% endif %}>

              <template x-for="(image, index) in images" :key="index">
                <img
                  x-show="currentImage === index"
                  x-transition
                  :src="image.fileUrl"
                  :alt="'{{ product.title }}'"
                  class="absolute inset-0 w-full h-full object-cover"
                  :style="zoom ? `transform-origin: ${zoomX}% ${zoomY}%; transform: scale(1.5)` : ''">
              </template>

              {% if not product.images or product.images.length == 0 %}
                <div class="w-full h-full flex items-center justify-center bg-gray-200">
                  <svg class="w-24 h-24 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </div>
              {% endif %}

              {# Arrows #}
              <template x-if="images.length > 1">
                <div>
                  <button @click.stop="prev()" class="absolute top-1/2 -translate-y-1/2 start-2 z-10 w-10 h-10 bg-white/90 rounded-full flex items-center justify-center shadow-md hover:bg-white">
                    <svg class="w-5 h-5 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                  </button>
                  <button @click.stop="next()" class="absolute top-1/2 -translate-y-1/2 end-2 z-10 w-10 h-10 bg-white/90 rounded-full flex items-center justify-center shadow-md hover:bg-white">
                    <svg class="w-5 h-5 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                  </button>
                </div>
              </template>

              {# Badges #}
              <div class="absolute top-4 start-4 flex flex-col gap-2 z-10">
                {% if hasDiscount %}<span class="badge badge-sale">-{{ discountPercent }}%</span>{% endif %}
                {% if product.isNew %}<span class="badge badge-new">{{t("product.new")}}</span>{% endif %}
              </div>
            </div>

            {# Thumbnails (Bottom) #}
            {% if thumbnailsPosition == 'bottom' and product.images | length > 1 %}
              <div class="flex gap-2 mt-4 overflow-x-auto pb-2">
                {% for image in product.images %}
                  <button
                    @click="goTo({{ loop.index0 }})"
                    :class="currentImage === {{ loop.index0 }} ? 'ring-2 ring-primary' : 'ring-1 ring-gray-200'"
                    class="w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden bg-gray-100 flex-shrink-0">
                    <img src="{{ image.fileUrl }}" alt="{{ product.title }}" class="w-full h-full object-cover">
                  </button>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>

        {# Lightbox #}
        {% if enableLightbox %}
          <div x-show="lightbox" x-transition @click="lightbox = false" @keydown.escape.window="lightbox = false" class="fixed inset-0 z-50 bg-black/95 flex items-center justify-center p-4">
            <button @click="lightbox = false" class="absolute top-4 end-4 z-10 w-12 h-12 bg-white/10 rounded-full flex items-center justify-center text-white hover:bg-white/20">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <template x-if="images.length > 1">
              <div>
                <button @click.stop="prev()" class="absolute top-1/2 -translate-y-1/2 start-4 z-10 w-12 h-12 bg-white/10 rounded-full flex items-center justify-center text-white hover:bg-white/20">
                  <svg class="w-6 h-6 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <button @click.stop="next()" class="absolute top-1/2 -translate-y-1/2 end-4 z-10 w-12 h-12 bg-white/10 rounded-full flex items-center justify-center text-white hover:bg-white/20">
                  <svg class="w-6 h-6 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </button>
              </div>
            </template>
            <img :src="images[currentImage]?.fileUrl" @click.stop class="max-w-full max-h-full object-contain">
          </div>
        {% endif %}
      </div>

      {# Product Info #}
      <div class="{% if widget.data.gallery_position == 'end' %}lg:order-1{% endif %}">

        {# Vendor #}
        {% if widget.data.show_vendor and product.vendor %}
          <a href="/collections/{{ product.vendor | lower | replace(' ', '-') }}" class="text-sm text-primary hover:underline mb-2 inline-block">{{ product.vendor }}</a>
        {% endif %}

        {# Title #}
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-3">{{ product.title }}</h1>

        {# Rating #}
        {% if widget.data.show_rating and product.rating %}
          <div class="flex items-center gap-2 mb-4">
            <div class="star-rating">
              {% for i in range(1, 6) %}
                <svg class="w-5 h-5 {% if i <= product.rating %}star-filled{% else %}star-empty{% endif %}" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              {% endfor %}
            </div>
            <span class="text-sm text-gray-500">({{ product.reviewsCount | default(0) }} {{t("product.reviews")}})</span>
          </div>
        {% endif %}

        {# Price #}
        <div class="flex items-center gap-3 mb-6">
          <span class="text-3xl font-bold text-primary" data-money="{{ product.pricing.price }}">{{ product.pricing.price | money }}</span>
          {% if hasDiscount %}
            <span class="text-lg text-gray-400 line-through" data-money="{{ product.pricing.compareAtPrice }}">{{ product.pricing.compareAtPrice | money }}</span>
            <span class="badge badge-sale">-{{ discountPercent }}%</span>
          {% endif %}
        </div>

        {# Short Description #}
        {% if product.shortDescription %}
          <p class="text-gray-600 mb-6">{{ product.shortDescription }}</p>
        {% endif %}

        {# Stock #}
        {% if widget.data.show_stock %}
          <div class="flex items-center gap-2 mb-6">
            {% if isOutOfStock %}
              <span class="w-3 h-3 bg-red-500 rounded-full"></span>
              <span class="text-red-500 font-medium">{{t("product.out_of_stock")}}</span>
            {% elif product.quantity <= 5 %}
              <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
              <span class="text-orange-500 font-medium">{{t("product.limited_stock")}} ({{ product.quantity }})</span>
            {% else %}
              <span class="w-3 h-3 bg-green-500 rounded-full"></span>
              <span class="text-green-500 font-medium">{{t("product.in_stock")}}</span>
            {% endif %}
          </div>
        {% endif %}

        {# Options #}
        {% if product.options and product.options.length > 0 %}
          <div class="space-y-4 mb-6">
            {% for option in product.options %}
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  {{ option.name }}: <span class="font-normal text-gray-500" x-text="selectedOptions['{{ option.name }}']"></span>
                </label>
                {% if option.type == 'color' %}
                  <div class="flex flex-wrap gap-2">
                    {% for value in option.values %}
                      <button
                        @click="selectedOptions['{{ option.name }}'] = '{{ value.name }}'"
                        :class="selectedOptions['{{ option.name }}'] === '{{ value.name }}' ? 'ring-2 ring-primary ring-offset-2' : ''"
                        class="w-10 h-10 rounded-full border-2 border-gray-200"
                        style="background-color: {{ value.color | default('#ccc') }}"
                        title="{{ value.name }}"></button>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="flex flex-wrap gap-2">
                    {% for value in option.values %}
                      <button
                        @click="selectedOptions['{{ option.name }}'] = '{{ value.name }}'"
                        :class="selectedOptions['{{ option.name }}'] === '{{ value.name }}' ? 'bg-primary text-white border-primary' : 'bg-white text-gray-700 border-gray-300 hover:border-primary'"
                        class="px-4 py-2 border rounded-lg font-medium transition-all">{{ value.name }}</button>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        {# Quantity & Add to Cart #}
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
          <div class="quantity-input">
            <button @click="decrement()" :disabled="quantity <= 1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
            </button>
            <input type="number" x-model="quantity" min="1" max="{{ product.quantity | default(99) }}">
            <button @click="increment()" :disabled="quantity >= {{ product.quantity | default(99) }}">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            </button>
          </div>
          <button @click="addToCart()" :disabled="loading || {{ 'true' if isOutOfStock else 'false' }}" class="flex-1 btn btn-primary btn-lg">
            <template x-if="!loading">
              <span class="flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                {% if isOutOfStock %}{{t("product.out_of_stock")}}{% else %}{{t("product.add_to_cart")}}{% endif %}
              </span>
            </template>
            <template x-if="loading"><span class="loading-spinner w-5 h-5"></span></template>
          </button>
          <button @click="addToWishlist()" data-wishlist-btn="{{ product._id }}" class="btn btn-outline px-4">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
          </button>
        </div>

        {# SKU #}
        {% if widget.data.show_sku and product.sku %}
          <p class="text-sm text-gray-500 mb-4">{{t("product.sku")}}: <span class="font-medium">{{ product.sku }}</span></p>
        {% endif %}

        {# Share #}
        {% if widget.data.show_share %}
          <div class="flex items-center gap-4 pt-4 border-t">
            <span class="text-sm text-gray-500">{{t("product.share")}}:</span>
            <div class="flex gap-2">
              <a href="https://www.facebook.com/sharer/sharer.php?u={{ store.url }}/product/{{ product.slug }}" target="_blank" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-blue-500 hover:text-white transition-colors">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.77,7.46H14.5v-1.9c0-.9.6-1.1,1-1.1h3V.5h-4.33C10.24.5,9.5,3.44,9.5,5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4Z"/></svg>
              </a>
              <a href="https://wa.me/?text={{ product.title }}%20{{ store.url }}/product/{{ product.slug }}" target="_blank" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-green-500 hover:text-white transition-colors">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.47,22.25c-1.67,0-4.16-.91-7.21-3.16a20.24,20.24,0,0,1-5.2-5.62A11.76,11.76,0,0,1,3.17,7.35a4.16,4.16,0,0,1,1.4-3.22,3.2,3.2,0,0,1,2-1A1.59,1.59,0,0,1,8,3.89l1.83,3.19a1.88,1.88,0,0,1-.43,2.38l-.54.54a.3.3,0,0,0-.07.34,10.53,10.53,0,0,0,2.22,2.93,10.2,10.2,0,0,0,3.09,2.19.31.31,0,0,0,.34-.07l.49-.49a1.87,1.87,0,0,1,2.42-.39l3.2,1.89a1.59,1.59,0,0,1,.72,1.45,3.26,3.26,0,0,1-1,2A4.2,4.2,0,0,1,17.47,22.25Z"/></svg>
              </a>
              <button @click="navigator.clipboard.writeText(window.location.href); Qumra.toast.success('تم نسخ الرابط')" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-primary hover:text-white transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
              </button>
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    {# Tabs #}
    {% if widget.data.show_tabs %}
      <div class="mt-12" x-data="{ activeTab: 'description' }">
        <div class="tabs border-b overflow-x-auto">
          <button @click="activeTab = 'description'" :class="activeTab === 'description' ? 'active' : ''" class="tab">{{t("product.description")}}</button>
          {% if product.specifications %}
            <button @click="activeTab = 'specifications'" :class="activeTab === 'specifications' ? 'active' : ''" class="tab">{{t("product.specifications")}}</button>
          {% endif %}
          <button @click="activeTab = 'shipping'" :class="activeTab === 'shipping' ? 'active' : ''" class="tab">{{t("product.shipping_info")}}</button>
        </div>
        <div class="py-6">
          <div x-show="activeTab === 'description'" x-transition class="prose prose-lg max-w-none">
            {{ product.description | safe | default('لا يوجد وصف متاح') }}
          </div>
          {% if product.specifications %}
            <div x-show="activeTab === 'specifications'" x-transition>
              <table class="w-full">
                <tbody>
                  {% for spec in product.specifications %}
                    <tr class="border-b"><td class="py-3 text-gray-500 w-1/3">{{ spec.name }}</td><td class="py-3 font-medium">{{ spec.value }}</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
          <div x-show="activeTab === 'shipping'" x-transition>
            <div class="space-y-4">
              <div class="flex items-start gap-4 p-4 bg-surface rounded-lg">
                <svg class="w-6 h-6 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                <div><h4 class="font-medium mb-1">الشحن والتوصيل</h4><p class="text-gray-600 text-sm">نوفر الشحن لجميع مناطق المملكة. التوصيل خلال 2-5 أيام عمل.</p></div>
              </div>
              <div class="flex items-start gap-4 p-4 bg-surface rounded-lg">
                <svg class="w-6 h-6 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                <div><h4 class="font-medium mb-1">الإرجاع والاستبدال</h4><p class="text-gray-600 text-sm">يمكنك إرجاع أو استبدال المنتج خلال 14 يوم من تاريخ الاستلام.</p></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    {# Related Products #}
    {% if widget.data.show_related and product.relatedProducts and product.relatedProducts.length > 0 %}
      <section class="mt-12 py-12 bg-surface -mx-4 px-4 md:-mx-8 md:px-8">
        <h2 class="text-2xl font-bold mb-6">{{t("product.related_products")}}</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
          {% for item in product.relatedProducts | slice(0, widget.data.related_count | default(4)) %}
            {% ui "product-card.njk", product=item %}
          {% endfor %}
        </div>
      </section>
    {% endif %}
  </div>

  {# Sticky Mobile Add to Cart #}
  {% if widget.data.sticky_add_to_cart and not isOutOfStock %}
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg p-4 z-40 md:hidden">
      <div class="flex items-center gap-3">
        <div class="flex-1">
          <p class="text-sm text-gray-500 line-clamp-1">{{ product.title }}</p>
          <p class="font-bold text-primary" data-money="{{ product.pricing.price }}">{{ product.pricing.price | money }}</p>
        </div>
        <button @click="addToCart()" :disabled="loading" class="btn btn-primary">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
          {{t("product.add_to_cart")}}
        </button>
      </div>
    </div>
  {% endif %}
</div>
